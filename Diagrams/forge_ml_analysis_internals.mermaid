%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#1e293b', 'primaryTextColor': '#f1f5f9', 'primaryBorderColor': '#475569', 'lineColor': '#a855f7', 'secondaryColor': '#0f172a', 'tertiaryColor': '#334155', 'background': '#020617', 'mainBkg': '#1e293b', 'nodeBorder': '#a855f7', 'clusterBkg': '#0f172a', 'clusterBorder': '#475569'}}}%%

flowchart TB
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% FORGE CASCADE: ML ANALYSIS (PHASE 2) INTERNALS
    %% 
    %% Example Input:
    %% User "alice" asks: "What were the key findings from last 
    %% quarter's security audit?"
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    %% Entry Point
    INPUT[/"ğŸ“¥ Phase 2 Receives Request<br/><br/>content: 'What were the key findings<br/>from last quarter's security audit?'<br/>user_id: 'alice'<br/>user_history_embedding: float[1536]"/]

    %% WebAssembly Sandbox
    subgraph WASM["ğŸ”’ WebAssembly Sandbox (ml_intelligence.wasm)"]
        direction TB
        
        INIT["âš™ï¸ Overlay Initialization<br/><br/>fuel_limit: 5,000,000 cycles<br/>capabilities: [DATABASE_READ, EVENT_PUBLISH]<br/>anomaly_threshold: 0.85<br/>model_trained: true"]
        
        ANALYZE["ğŸ“¨ analyze(payload) called<br/><br/>Receives JSON payload with:<br/>â€¢ content (the query text)<br/>â€¢ user_history (embedding vector)"]
        
        INIT --> ANALYZE
    end
    
    INPUT --> WASM

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% FIVE PARALLEL ML FUNCTIONS
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    subgraph ML_FUNCTIONS["ğŸ§  ML Analysis Functions (run in parallel)"]
        direction TB
        
        %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        %% ANOMALY DETECTION
        %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        subgraph ANOMALY["1ï¸âƒ£ Anomaly Detection"]
            direction TB
            
            A1["Load sliding window<br/>(last 1000 samples)"]
            A2["Extract feature vector:<br/>â€¢ latency_ms<br/>â€¢ memory_mb<br/>â€¢ cpu_percent<br/>â€¢ error_rate<br/>â€¢ request_rate<br/>â€¢ fuel_consumed"]
            A3["IsolationForest Model<br/><br/>contamination: 0.01<br/>n_estimators: 100"]
            A4["Calculate anomaly_score<br/><br/>Raw score â†’ Normalize to 0.0-1.0"]
            A5{"score > 0.85?"}
            A6["ğŸš¨ event_publish(<br/>'anomaly_detected',<br/>{score, severity, metrics})"]
            A7["anomaly_score: 0.12<br/>(normal behavior)"]
            
            A1 --> A2
            A2 --> A3
            A3 --> A4
            A4 --> A5
            A5 -->|"Yes"| A6
            A5 -->|"No"| A7
        end

        %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        %% INTENT CLASSIFICATION
        %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        subgraph INTENT["2ï¸âƒ£ Intent Classification"]
            direction TB
            
            I1["Tokenize query text"]
            I2["Extract intent signals:<br/>â€¢ 'What were' â†’ question<br/>â€¢ 'key findings' â†’ retrieval<br/>â€¢ 'security audit' â†’ domain"]
            I3["Classify against known intents:<br/>â€¢ information_retrieval<br/>â€¢ knowledge_creation<br/>â€¢ governance_action<br/>â€¢ capsule_modification<br/>â€¢ system_query"]
            I4["intent: 'information_retrieval'<br/>confidence: 0.94"]
            
            I1 --> I2
            I2 --> I3
            I3 --> I4
        end

        %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        %% CONTENT CATEGORIZATION
        %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        subgraph CATEGORY["3ï¸âƒ£ Content Categorization"]
            direction TB
            
            C1["Named Entity Recognition<br/><br/>Entities found:<br/>â€¢ 'security audit'<br/>â€¢ 'last quarter' (Q3)<br/>â€¢ 'key findings'"]
            C2["Map to capsule taxonomy"]
            C3["Query Neo4j for category stats:<br/><br/>db_read('MATCH (c:Capsule)<br/>WHERE c.type IN $types<br/>RETURN c.category, count(*)')"]
            C4["categories:<br/>['security', 'audit',<br/>'compliance', 'Q3-2025']"]
            
            C1 --> C2
            C2 --> C3
            C3 --> C4
        end

        %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        %% SENTIMENT ANALYSIS
        %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        subgraph SENTIMENT["4ï¸âƒ£ Sentiment Analysis"]
            direction TB
            
            S1["Analyze emotional tone<br/>of query text"]
            S2["Check for:<br/>â€¢ Frustration markers<br/>â€¢ Urgency indicators<br/>â€¢ Positive/negative words"]
            S3["sentiment: 'neutral'<br/>(factual query, no emotion)"]
            
            S1 --> S2
            S2 --> S3
        end

        %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        %% COMPLEXITY SCORING
        %% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        subgraph COMPLEXITY["5ï¸âƒ£ Complexity Scoring"]
            direction TB
            
            X1["Analyze query structure:<br/>â€¢ Word count: 11<br/>â€¢ Clause count: 1<br/>â€¢ Technical terms: 2"]
            X2["Check domain depth:<br/>â€¢ 'security audit' â†’ specialized<br/>â€¢ 'key findings' â†’ summary request"]
            X3["Estimate response needs:<br/>â€¢ Multi-part answer likely<br/>â€¢ Technical detail expected"]
            X4["complexity_score: 0.72<br/>(moderately complex)"]
            
            X1 --> X2
            X2 --> X3
            X3 --> X4
        end
    end
    
    ANALYZE --> ML_FUNCTIONS

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% PATTERN DETECTION (Cross-cutting concern)
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    subgraph PATTERNS["ğŸ” Pattern Recognition (Cross-Cutting)"]
        direction LR
        
        P1["Scan for known patterns:<br/>â€¢ Code patterns<br/>â€¢ Usage patterns<br/>â€¢ Attack signatures"]
        P2["Compare against user history<br/>(user_history_embedding)"]
        P3{"New pattern<br/>discovered?"}
        P4["ğŸ¯ event_publish(<br/>'pattern_detected',<br/>{pattern, confidence})"]
        P5["patterns: []<br/>(no new patterns)"]
        
        P1 --> P2
        P2 --> P3
        P3 -->|"Yes"| P4
        P3 -->|"No"| P5
    end

    ML_FUNCTIONS --> PATTERNS

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% RESULT AGGREGATION
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    subgraph AGGREGATE["ğŸ“Š Result Aggregation"]
        direction TB
        
        AGG1["Combine all ML outputs"]
        AGG2["Calculate overall confidence<br/><br/>confidence = mean(<br/>  intent_conf,<br/>  category_conf,<br/>  anomaly_certainty<br/>)"]
        AGG3["Build Phase2Result object"]
    end

    PATTERNS --> AGGREGATE
    A7 --> AGGREGATE
    I4 --> AGGREGATE
    C4 --> AGGREGATE
    S3 --> AGGREGATE
    X4 --> AGGREGATE

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% FINAL OUTPUT
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    OUTPUT[/"ğŸ“¤ Phase2Result<br/><br/>{<br/>  anomaly_score: 0.12,<br/>  intent: 'information_retrieval',<br/>  categories: ['security', 'audit', 'compliance', 'Q3-2025'],<br/>  sentiment: 'neutral',<br/>  complexity_score: 0.72,<br/>  patterns: [],<br/>  confidence: 0.92<br/>}"/]

    AGGREGATE --> OUTPUT

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% DOWNSTREAM EFFECTS
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    subgraph DOWNSTREAM["â¬‡ï¸ How Phase 2 Output Affects Later Phases"]
        direction TB
        
        D4["Phase 4: Optimization<br/><br/>complexity_score: 0.72 â†’ 0.7<br/>â€¢ temperature = 0.7 (creative)<br/>â€¢ max_tokens = 2000 (detailed)"]
        
        D5["Phase 5: Intelligence<br/><br/>intent: 'information_retrieval'<br/>â€¢ Prompt tuned for Q&A format<br/>â€¢ Focus on capsule synthesis<br/><br/>categories: ['security', 'audit']<br/>â€¢ Weight security-related capsules"]
        
        D7["Phase 7: Storage<br/><br/>categories: ['security', 'audit']<br/>â€¢ If saved, capsule tagged correctly<br/><br/>sentiment: 'neutral'<br/>â€¢ No feedback loop triggered"]
    end

    OUTPUT --> DOWNSTREAM

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% CASCADE EVENTS (if triggered)
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    subgraph CASCADE["ğŸŒŠ Potential Cascade Events"]
        direction LR
        
        CE1["If anomaly_detected:<br/>â†’ security_validator updates model<br/>â†’ performance_optimizer reallocates<br/>â†’ governance may auto-propose"]
        
        CE2["If pattern_detected:<br/>â†’ Other overlays learn new pattern<br/>â†’ Knowledge graph enriched<br/>â†’ Future queries benefit"]
    end

    A6 -.->|"event bus"| CASCADE
    P4 -.->|"event bus"| CASCADE

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% STYLING
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    classDef input fill:#065f46,stroke:#34d399,stroke-width:2px,color:#fff
    classDef wasm fill:#7c2d12,stroke:#fb923c,stroke-width:2px,color:#fff
    classDef ml fill:#1e3a8a,stroke:#60a5fa,stroke-width:2px,color:#fff
    classDef anomaly fill:#7f1d1d,stroke:#f87171,stroke-width:2px,color:#fff
    classDef intent fill:#312e81,stroke:#a5b4fc,stroke-width:2px,color:#fff
    classDef category fill:#134e4a,stroke:#5eead4,stroke-width:2px,color:#fff
    classDef sentiment fill:#4c1d95,stroke:#c4b5fd,stroke-width:2px,color:#fff
    classDef complexity fill:#78350f,stroke:#fcd34d,stroke-width:2px,color:#fff
    classDef output fill:#14532d,stroke:#4ade80,stroke-width:2px,color:#fff
    classDef cascade fill:#581c87,stroke:#d8b4fe,stroke-width:2px,color:#fff
    classDef decision fill:#991b1b,stroke:#fca5a5,stroke-width:2px,color:#fff

    class INPUT input
    class WASM,INIT,ANALYZE wasm
    class ANOMALY,A1,A2,A3,A4,A6,A7 anomaly
    class INTENT,I1,I2,I3,I4 intent
    class CATEGORY,C1,C2,C3,C4 category
    class SENTIMENT,S1,S2,S3 sentiment
    class COMPLEXITY,X1,X2,X3,X4 complexity
    class OUTPUT output
    class CASCADE,CE1,CE2 cascade
    class A5,P3 decision
