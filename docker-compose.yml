version: '3.8'

services:
  # ==========================================================================
  # Core Services
  # ==========================================================================

  cascade-api:
    build:
      context: ./forge-cascade-v2
      dockerfile: Dockerfile
    container_name: forge-cascade-api
    ports:
      - "8001:8001"
    environment:
      - NEO4J_URI=${NEO4J_URI}
      - NEO4J_USERNAME=${NEO4J_USERNAME}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-60}
      - REDIS_URL=redis://redis:6379
      - PYTHONUNBUFFERED=1
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - forge-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  compliance-api:
    build:
      context: ./forge-cascade-v2
      dockerfile: Dockerfile
    container_name: forge-compliance-api
    command: ["python", "run_compliance.py"]
    ports:
      - "8002:8002"
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - forge-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  virtuals-api:
    build:
      context: ./forge-cascade-v2
      dockerfile: Dockerfile
    container_name: forge-virtuals-api
    command: ["python", "run_virtuals.py"]
    ports:
      - "8003:8003"
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - forge-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ==========================================================================
  # Frontend
  # ==========================================================================

  frontend:
    build:
      context: ./forge-cascade-v2/frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=http://localhost:8001/api/v1
    container_name: forge-frontend
    ports:
      - "80:80"
    depends_on:
      cascade-api:
        condition: service_healthy
    networks:
      - forge-network
    restart: unless-stopped

  # ==========================================================================
  # Infrastructure
  # ==========================================================================

  redis:
    image: redis:7-alpine
    container_name: forge-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - forge-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    command: redis-server --appendonly yes

  # ==========================================================================
  # Database Setup (run once)
  # ==========================================================================

  db-setup:
    build:
      context: ./forge-cascade-v2
      dockerfile: Dockerfile
    container_name: forge-db-setup
    command: ["python", "scripts/setup_db.py"]
    environment:
      - NEO4J_URI=${NEO4J_URI}
      - NEO4J_USERNAME=${NEO4J_USERNAME}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
    networks:
      - forge-network
    profiles:
      - setup

  db-seed:
    build:
      context: ./forge-cascade-v2
      dockerfile: Dockerfile
    container_name: forge-db-seed
    command: ["python", "scripts/seed_data.py"]
    environment:
      - NEO4J_URI=${NEO4J_URI}
      - NEO4J_USERNAME=${NEO4J_USERNAME}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - SEED_ADMIN_PASSWORD=${SEED_ADMIN_PASSWORD}
    networks:
      - forge-network
    profiles:
      - setup

networks:
  forge-network:
    driver: bridge

volumes:
  redis-data:
