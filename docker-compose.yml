services:
  # ==========================================================================
  # Core Services
  # ==========================================================================

  cascade-api:
    build:
      context: ./forge-cascade-v2
      dockerfile: Dockerfile
    container_name: forge-cascade-api
    # SECURITY FIX: Bind to localhost for development, use reverse proxy in production
    ports:
      - "127.0.0.1:8001:8001"
    # SECURITY FIX: Add security options
    security_opt:
      - no-new-privileges:true
    environment:
      - NEO4J_URI=${NEO4J_URI}
      - NEO4J_USERNAME=${NEO4J_USERNAME}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-60}
      # SECURITY FIX: REDIS_PASSWORD must be set, no default
      - REDIS_URL=redis://:${REDIS_PASSWORD:?REDIS_PASSWORD environment variable is required}@redis:6379
      - LLM_PROVIDER=${LLM_PROVIDER:-mock}
      - LLM_API_KEY=${LLM_API_KEY:-}
      - LLM_MODEL=${LLM_MODEL:-gpt-4.1-nano}
      - LLM_MAX_TOKENS=${LLM_MAX_TOKENS:-2000}
      - LLM_TEMPERATURE=${LLM_TEMPERATURE:-0.4}
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-mock}
      - EMBEDDING_API_KEY=${EMBEDDING_API_KEY:-}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-text-embedding-3-small}
      - EMBEDDING_DIMENSIONS=${EMBEDDING_DIMENSIONS:-1536}
      - OTLP_ENDPOINT=http://jaeger:4317
      - SENTRY_DSN=${SENTRY_DSN:-}
      - CORS_ORIGINS=${CORS_ORIGINS:-https://forgecascade.org,https://forgeshop.org,http://localhost:3000,http://localhost:5173}
      - APP_ENV=${APP_ENV:-production}
      - PYTHONUNBUFFERED=1
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - forge-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  compliance-api:
    build:
      context: ./forge-cascade-v2
      dockerfile: Dockerfile
    container_name: forge-compliance-api
    command: ["python", "run_compliance.py"]
    # SECURITY FIX: Bind to localhost for development
    ports:
      - "127.0.0.1:8002:8002"
    # SECURITY FIX: Add security options
    security_opt:
      - no-new-privileges:true
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - forge-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  virtuals-api:
    build:
      context: ./forge-cascade-v2
      dockerfile: Dockerfile
    container_name: forge-virtuals-api
    command: ["python", "run_virtuals.py"]
    # SECURITY FIX: Bind to localhost for development
    ports:
      - "127.0.0.1:8003:8003"
    # SECURITY FIX: Add security options
    security_opt:
      - no-new-privileges:true
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - forge-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # ==========================================================================
  # Frontend
  # ==========================================================================

  frontend:
    build:
      context: ./forge-cascade-v2/frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=https://forgecascade.org/api/v1
    container_name: forge-frontend
    ports:
      - "80:80"
    # SECURITY FIX: Add security options
    security_opt:
      - no-new-privileges:true
    depends_on:
      cascade-api:
        condition: service_healthy
    networks:
      - forge-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 64M

  marketplace:
    build:
      context: ./marketplace
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=https://forgeshop.org/api
        - VITE_CASCADE_API_URL=https://forgecascade.org/api/v1
        - VITE_WS_URL=wss://forgeshop.org/ws
        - VITE_APP_NAME=Forge Shop
    container_name: forge-marketplace
    ports:
      - "3001:80"
    # SECURITY FIX: Add security options
    security_opt:
      - no-new-privileges:true
    networks:
      - forge-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 64M

  # ==========================================================================
  # Infrastructure
  # ==========================================================================

  redis:
    # SECURITY FIX: Pin image version instead of using floating tag
    image: redis:7.4.1-alpine
    container_name: forge-redis
    # SECURITY FIX: Remove external port exposure - Redis should only be accessible internally
    # ports:
    #   - "6379:6379"  # Commented out for security - use expose instead for internal access
    expose:
      - "6379"  # Only expose internally within Docker network
    volumes:
      - redis-data:/data
    networks:
      - forge-network
    restart: unless-stopped
    # SECURITY FIX: Run as non-root user
    user: "999:999"  # Redis user in Alpine image
    healthcheck:
      # SECURITY FIX: REDIS_PASSWORD must be set, no default
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:?REDIS_PASSWORD required}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    # SECURITY FIX: REDIS_PASSWORD must be set, no default
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:?REDIS_PASSWORD required}
    # SECURITY FIX: Add security options
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

  jaeger:
    # SECURITY FIX: Pin image version instead of using :latest
    image: jaegertracing/all-in-one:1.63.0
    container_name: forge-jaeger
    # SECURITY FIX: Only expose Jaeger UI externally, OTLP ports should be internal only
    ports:
      - "127.0.0.1:16686:16686"  # Jaeger UI - bind to localhost only
    expose:
      - "4317"    # OTLP gRPC - internal only
      - "4318"    # OTLP HTTP - internal only
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    networks:
      - forge-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:14269/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    # SECURITY FIX: Add security options
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M

  # ==========================================================================
  # Database Setup (run once)
  # ==========================================================================

  db-setup:
    build:
      context: ./forge-cascade-v2
      dockerfile: Dockerfile
    container_name: forge-db-setup
    command: ["python", "scripts/setup_db.py"]
    environment:
      - NEO4J_URI=${NEO4J_URI}
      - NEO4J_USERNAME=${NEO4J_USERNAME}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
    networks:
      - forge-network
    profiles:
      - setup

  db-seed:
    build:
      context: ./forge-cascade-v2
      dockerfile: Dockerfile
    container_name: forge-db-seed
    command: ["python", "scripts/seed_data.py"]
    environment:
      - NEO4J_URI=${NEO4J_URI}
      - NEO4J_USERNAME=${NEO4J_USERNAME}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - SEED_ADMIN_PASSWORD=${SEED_ADMIN_PASSWORD}
    networks:
      - forge-network
    profiles:
      - setup

networks:
  forge-network:
    driver: bridge

volumes:
  redis-data:
