# Forge Cascade V2 - Docker Compose Configuration
# Full stack deployment with backend, frontend, and Redis

version: '3.8'

services:
  # Backend API
  backend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.backend
    container_name: forge-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - FORGE_ENV=production
      - NEO4J_URI=${NEO4J_URI}
      - NEO4J_USERNAME=${NEO4J_USERNAME}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - NEO4J_DATABASE=${NEO4J_DATABASE:-neo4j}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}
      - ACCESS_TOKEN_EXPIRE_MINUTES=${ACCESS_TOKEN_EXPIRE_MINUTES:-30}
      - REFRESH_TOKEN_EXPIRE_DAYS=${REFRESH_TOKEN_EXPIRE_DAYS:-7}
      # SECURITY FIX: REDIS_PASSWORD must be set, no default
      - REDIS_URL=${REDIS_URL:-redis://:${REDIS_PASSWORD:?REDIS_PASSWORD required}@redis:6379/0}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/system/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    networks:
      - forge-network
    volumes:
      - forge-logs:/app/logs
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "5"
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2"

  # Frontend
  frontend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.frontend
    container_name: forge-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - forge-network
    logging:
      driver: json-file
      options:
        max-size: "20m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 256M

  # Redis for caching and pub/sub
  redis:
    # SECURITY FIX: Pin to specific version
    image: redis:7.4.1-alpine
    container_name: forge-redis
    restart: unless-stopped
    # SECURITY FIX: Only expose Redis to localhost for development debugging
    # In production, remove ports entirely - use internal network only
    ports:
      - "127.0.0.1:6379:6379"
    # SECURITY FIX: REDIS_PASSWORD must be set, no default
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru --requirepass ${REDIS_PASSWORD:?REDIS_PASSWORD required}
    healthcheck:
      # SECURITY FIX: REDIS_PASSWORD must be set, no default
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:?REDIS_PASSWORD required}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - forge-network
    volumes:
      - redis-data:/data
    logging:
      driver: json-file
      options:
        max-size: "20m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 512M

networks:
  forge-network:
    driver: bridge

volumes:
  forge-logs:
    driver: local
  redis-data:
    driver: local
